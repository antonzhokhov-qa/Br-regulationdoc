# Документация по взаимодействию компонентов системы проверки балансов

## Общее описание

Система представляет собой комплекс микросервисов для автоматизированной сверки соответствия сумм балансов графических счетов пользователей на проекте **BetBoom** и сумм балансов транзакционных аккаунтов у поставщиков платежных решений.

---

## Причины создания системы

Система была разработана в соответствии с требованиями регуляторов, касающимися раздельного учета транзакционных и операционных балансов. Основные причины:

1. **Раздельные активы:**
   - Средства игроков на транзакционных счетах должны быть отдельными от активов оператора.

2. **Защита от обязательств оператора:**
   - Средства не могут быть арестованы из-за долгов оператора.

3. **Банкротство и ликвидация:**
   - Средства на транзакционных счетах не считаются активами оператора при банкротстве.

4. **Запрет на использование средств:**
   - Оператор не может использовать средства игроков для собственных расходов.

5. **Отдельные транзакционные счета:**
   - Оператор может использовать разные счета, но должен поддерживать баланс, равный сумме балансов всех игроков.

---

## Компоненты системы

### Обновленная диаграмма системы

*Диаграмма ниже отражает взаимодействие пользователя через фронтенд, включая возможность перемещения средств между балансами.*

![Диаграмма системы](link_to_updated_diagram_image_with_user_interaction)

---

### `backoffice_frontend`

**Назначение:**

- Предоставление пользовательского интерфейса для взаимодействия с системой.

**Основные функции:**

- Отображение информации о балансах и результатах сверок.
- Предоставление возможности инициировать перемещение средств между транзакционными и операционными балансами.

**Взаимодействие:**

- Отправляет запросы в `backoffice_backend`.
- Получает данные и результаты операций для отображения пользователю.

### `backoffice_backend`

**Обновленные функции:**

- **Обработка запросов на перемещение средств:**
  - Принимает запросы от фронтенда для перемещения средств.

- **Взаимодействие с `account-service`:**
  - Передает запросы на перемещение средств.

### `account-service`

**Обновленные функции:**

- **Обработка перемещения средств:**
  - Инициирует запросы к соответствующему `integration-service` для перемещения средств между балансами.

- **Обновление данных:**
  - Обновляет информацию о балансах после успешного перемещения средств.

### `integration-service`

**Обновленные функции:**

- **Перемещение средств между балансами:**
  - Принимает запросы от `account-service` для перемещения средств.

- **Подтверждение операций:**
  - Возвращает результаты выполнения операций в `account-service`.

---

## Обновленные процессы

### Перемещение средств между балансами

1. **Инициирование запроса пользователем:**
   - Пользователь через `backoffice_frontend` инициирует запрос на перемещение средств между транзакционным и операционным балансами.

2. **Обработка запроса на бекенде:**
   - `backoffice_frontend` отправляет запрос в `backoffice_backend`.
   - `backoffice_backend` проверяет корректность запроса и авторизацию пользователя.

3. **Передача запроса в `account-service`:**
   - `backoffice_backend` отправляет запрос в `account-service`.
   - `account-service` обрабатывает запрос и определяет, какой `integration-service` должен быть задействован.

4. **Взаимодействие с провайдером:**
   - `account-service` отправляет запрос в соответствующий `integration-service`.
   - `integration-service` взаимодействует с `payment-provider` для выполнения перемещения средств.

5. **Обновление балансов:**
   - После успешного выполнения операции `integration-service` возвращает результат в `account-service`.
   - `account-service` обновляет данные в `db_account_balances`.

6. **Уведомление пользователя:**
   - `account-service` через `backoffice_backend` уведомляет пользователя о результате операции.
   - `backoffice_frontend` отображает результат пользователю.

---

## Обработка ошибок при перемещении средств

### Возможные ошибки:

- Недостаточно средств на одном из балансов.
- Ошибки связи с `payment-provider`.
- Отказ в операции со стороны `payment-provider`.

### Действия системы:

1. **Логирование ошибок:**
   - Все ошибки записываются в журнал для дальнейшего анализа.

2. **Уведомление пользователя:**
   - Пользователь получает уведомление о неудачной операции и ее причине.

3. **Автоматические повторные попытки (если применимо):**
   - Система может повторить попытку выполнения операции, если это целесообразно.

4. **Уведомление администраторов:**
   - При критических ошибках администраторы системы получают уведомление.

---

## Безопасность и соответствие требованиям регуляторов

- **Изоляция средств игроков:**
  - Система гарантирует, что средства игроков на транзакционных счетах отделены от операционных средств.

- **Контроль перемещения средств:**
  - Все операции по перемещению средств протоколируются и проверяются на соответствие требованиям.

- **Аудит и отчеты:**
  - Система предоставляет отчеты для аудита и проверки регуляторами.

- **Защита данных:**
  - Используются современные методы шифрования и защиты данных.

---

## База данных

### `db_account_balances`

**Хранимые данные:**

- История проверок и временные метки.
- Результаты сверок и выявленные расхождения.
- Статусы операций и ошибок.
- Детализация по каждому провайдеру.
- Записи о перемещениях средств между балансами.
- Статусы и результаты операций по перемещению средств.
- История взаимодействий с каждым `payment-provider`.

### `db_cron`

**Хранимые данные:**

- Конфигурация расписаний проверок.
- Параметры и частота проверок.
- Статусы выполнения заданий.


